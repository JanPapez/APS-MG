function [X,Y,W] = simplexquad(m,dim)
% function setting the quadrature nodes and weights
% 
% INPUT: required algebraic degree
%        dimension of the domain, assumed dim == 2
%
% Jan Papez, Ani Miraci, December 2022
%       APS-MG MATLAB package https://github.com/JanPapez/APS-MG


switch m
    
    case 1
        X = 0.333333333333333;
        Y = 0.333333333333333;
        W = 0.500000000000000;
        
    case 2
        X = [0.166666666666667; 0.166666666666667; 0.666666666666667];
        Y = [0.166666666666667; 0.666666666666667; 0.166666666666667];
        W = ones(3,1)*0.166666666666667;
   
    case 3
        all = [
            0.333333333333333   0.333333333333333  -0.281250000000000
            0.200000000000000   0.200000000000000   0.260416666666667
            0.200000000000000   0.600000000000000   0.260416666666667
            0.600000000000000   0.200000000000000   0.260416666666667
            ];
        X = all(:,1); Y = all(:,2); W = all(:,3);
        
        
    case 4
        all = [
            0.445948490915965   0.445948490915965   0.111690794839006
            0.445948490915965   0.108103018168070   0.111690794839006
            0.108103018168070   0.445948490915965   0.111690794839006
            0.091576213509771   0.091576213509771   0.054975871827661
            0.091576213509771   0.816847572980459   0.054975871827661
            0.816847572980459   0.091576213509771   0.054975871827661
            ];
        X = all(:,1); Y = all(:,2); W = all(:,3);
        
    case 5
        all = [
            0.333333333333333   0.333333333333333   0.112500000000000
            0.470142064105115   0.470142064105115   0.066197076394253
            0.470142064105115   0.059715871789770   0.066197076394253
            0.059715871789770   0.470142064105115   0.066197076394253
            0.101286507323456   0.101286507323456   0.062969590272414
            0.101286507323456   0.797426985353087   0.062969590272414
            0.797426985353087   0.101286507323456   0.062969590272414
            ];
        X = all(:,1); Y = all(:,2); W = all(:,3);
        
    case 6
        all = [
            0.249286745170910   0.249286745170910   0.058393137863189
            0.249286745170910   0.501426509658179   0.058393137863189
            0.501426509658179   0.249286745170910   0.058393137863189
            0.063089014491502   0.063089014491502   0.025422453185104
            0.063089014491502   0.873821971016996   0.025422453185104
            0.873821971016996   0.063089014491502   0.025422453185104
            0.310352451033784   0.636502499121399   0.041425537809187
            0.636502499121399   0.053145049844817   0.041425537809187
            0.053145049844817   0.310352451033784   0.041425537809187
            0.310352451033784   0.053145049844817   0.041425537809187
            0.636502499121399   0.310352451033784   0.041425537809187
            0.053145049844817   0.636502499121399   0.041425537809187
            ];
        X = all(:,1); Y = all(:,2); W = all(:,3);
        
    case 7
        all = [
            0.333333333333333   0.333333333333333  -0.074785022233841
            0.260345966079040   0.260345966079040   0.087807628716604
            0.260345966079040   0.479308067841920   0.087807628716604
            0.479308067841920   0.260345966079040   0.087807628716604
            0.065130102902216   0.065130102902216   0.026673617804419
            0.065130102902216   0.869739794195568   0.026673617804419
            0.869739794195568   0.065130102902216   0.026673617804419
            0.312865496004874   0.638444188569810   0.038556880445128
            0.638444188569810   0.048690315425316   0.038556880445128
            0.048690315425316   0.312865496004874   0.038556880445128
            0.312865496004874   0.048690315425316   0.038556880445128
            0.638444188569810   0.312865496004874   0.038556880445128
            0.048690315425316   0.638444188569810   0.038556880445128
            ];
        X = all(:,1); Y = all(:,2); W = all(:,3);
        
    case 8
        all = [
            0.333333333333333   0.333333333333333   0.072157803838894
            0.459292588292723   0.459292588292723   0.047545817133642
            0.459292588292723   0.081414823414554   0.047545817133642
            0.081414823414554   0.459292588292723   0.047545817133642
            0.170569307751760   0.170569307751760   0.051608685267359
            0.170569307751760   0.658861384496480   0.051608685267359
            0.658861384496480   0.170569307751760   0.051608685267359
            0.050547228317031   0.050547228317031   0.016229248811599
            0.050547228317031   0.898905543365938   0.016229248811599
            0.898905543365938   0.050547228317031   0.016229248811599
            0.263112829634638   0.728492392955404   0.013615157087218
            0.728492392955404   0.008394777409958   0.013615157087218
            0.008394777409958   0.263112829634638   0.013615157087218
            0.263112829634638   0.008394777409958   0.013615157087218
            0.728492392955404   0.263112829634638   0.013615157087218
            0.008394777409958   0.728492392955404   0.013615157087218
            ];
        X = all(:,1); Y = all(:,2); W = all(:,3);
        
    case 9
        all = [
            0.333333333333333   0.333333333333333   0.048567898141400
            0.020634961602525   0.489682519198738   0.015667350113570
            0.489682519198738   0.489682519198738   0.015667350113570
            0.489682519198738   0.020634961602525   0.015667350113570
            0.125820817014127   0.437089591492937   0.038913770502387
            0.437089591492937   0.437089591492937   0.038913770502387
            0.437089591492937   0.125820817014127   0.038913770502387
            0.623592928761935   0.188203535619033   0.039823869463605
            0.188203535619033   0.188203535619033   0.039823869463605
            0.188203535619033   0.623592928761935   0.039823869463605
            0.910540973211095   0.044729513394453   0.012788837829349
            0.044729513394453   0.044729513394453   0.012788837829349
            0.044729513394453   0.910540973211095   0.012788837829349
            0.036838412054736   0.221962989160766   0.021641769688645
            0.221962989160766   0.741198598784498   0.021641769688645
            0.741198598784498   0.036838412054736   0.021641769688645
            0.221962989160766   0.036838412054736   0.021641769688645
            0.741198598784498   0.221962989160766   0.021641769688645
            0.036838412054736   0.741198598784498   0.021641769688645
        ];
        X = all(:,1); Y = all(:,2); W = all(:,3);
        
    case 10
        all = [
            0.333333333333333   0.333333333333333   0.045408995191377
            0.028844733232685   0.485577633383657   0.018362978878233
            0.485577633383657   0.485577633383657   0.018362978878233
            0.485577633383657   0.028844733232685   0.018362978878233
            0.781036849029926   0.109481575485037   0.022660529717764
            0.109481575485037   0.109481575485037   0.022660529717764
            0.109481575485037   0.781036849029926   0.022660529717764
            0.141707219414880   0.307939838764121   0.036378958422710
            0.307939838764121   0.550352941820999   0.036378958422710
            0.550352941820999   0.141707219414880   0.036378958422710
            0.307939838764121   0.141707219414880   0.036378958422710
            0.550352941820999   0.307939838764121   0.036378958422710
            0.141707219414880   0.550352941820999   0.036378958422710
            0.025003534762686   0.246672560639903   0.014163621265529
            0.246672560639903   0.728323904597411   0.014163621265529
            0.728323904597411   0.025003534762686   0.014163621265529
            0.246672560639903   0.025003534762686   0.014163621265529
            0.728323904597411   0.246672560639903   0.014163621265529
            0.025003534762686   0.728323904597411   0.014163621265529
            0.009540815400299   0.066803251012200   0.004710833481867
            0.066803251012200   0.923655933587500   0.004710833481867
            0.923655933587500   0.009540815400299   0.004710833481867
            0.066803251012200   0.009540815400299   0.004710833481867
            0.923655933587500   0.066803251012200   0.004710833481867
            0.009540815400299   0.923655933587500   0.004710833481867
        ];
        X = all(:,1); Y = all(:,2); W = all(:,3);
        
    case 11
        all = [
           -0.069222096541517   0.534611048270758   0.000463503164481
           0.534611048270758   0.534611048270758   0.000463503164481
           0.534611048270758  -0.069222096541517   0.000463503164481
           0.202061394068290   0.398969302965855   0.038574767457406
           0.398969302965855   0.398969302965855   0.038574767457406
           0.398969302965855   0.202061394068290   0.038574767457406
           0.593380199137435   0.203309900431282   0.029661488690387
           0.203309900431282   0.203309900431282   0.029661488690387
           0.203309900431282   0.593380199137435   0.029661488690387
           0.761298175434837   0.119350912282581   0.018092270251709
           0.119350912282581   0.119350912282581   0.018092270251709
           0.119350912282581   0.761298175434837   0.018092270251709
           0.935270103777448   0.032364948111276   0.006829865501339
           0.032364948111276   0.032364948111276   0.006829865501339
           0.032364948111276   0.935270103777448   0.006829865501339
           0.050178138310495   0.356620648261293   0.026168555981102
           0.356620648261293   0.593201213428213   0.026168555981102
           0.593201213428213   0.050178138310495   0.026168555981102
           0.356620648261293   0.050178138310495   0.026168555981102
           0.593201213428213   0.356620648261293   0.026168555981102
           0.050178138310495   0.593201213428213   0.026168555981102
           0.021022016536166   0.171488980304042   0.010353829819571
           0.171488980304042   0.807489003159792   0.010353829819571
           0.807489003159792   0.021022016536166   0.010353829819571
           0.171488980304042   0.021022016536166   0.010353829819571
           0.807489003159792   0.171488980304042   0.010353829819571
           0.021022016536166   0.807489003159792   0.010353829819571
            ];
        X = all(:,1); Y = all(:,2); W = all(:,3);  
    case 12
        all = [
            0.023565220452390   0.488217389773805   0.012865533220228
            0.488217389773805   0.488217389773805   0.012865533220228
            0.488217389773805   0.023565220452390   0.012865533220228
            0.120551215411079   0.439724392294460   0.021846272269019
            0.439724392294460   0.439724392294460   0.021846272269019
            0.439724392294460   0.120551215411079   0.021846272269019
            0.457579229975768   0.271210385012116   0.031429112108943
            0.271210385012116   0.271210385012116   0.031429112108943
            0.271210385012116   0.457579229975768   0.031429112108943
            0.744847708916828   0.127576145541586   0.017398056465355
            0.127576145541586   0.127576145541586   0.017398056465355
            0.127576145541586   0.744847708916828   0.017398056465355
            0.957365299093579   0.021317350453210   0.003083130525780
            0.021317350453210   0.021317350453210   0.003083130525780
            0.021317350453210   0.957365299093579   0.003083130525780
            0.115343494534698   0.275713269685514   0.020185778883191
            0.275713269685514   0.608943235779788   0.020185778883191
            0.608943235779788   0.115343494534698   0.020185778883191
            0.275713269685514   0.115343494534698   0.020185778883191
            0.608943235779788   0.275713269685514   0.020185778883191
            0.115343494534698   0.608943235779788   0.020185778883191
            0.022838332222257   0.281325580989940   0.011178386601152
            0.281325580989940   0.695836086787803   0.011178386601152
            0.695836086787803   0.022838332222257   0.011178386601152
            0.281325580989940   0.022838332222257   0.011178386601152
            0.695836086787803   0.281325580989940   0.011178386601152
            0.022838332222257   0.695836086787803   0.011178386601152
            0.025734050548330   0.116251915907597   0.008658115554329
            0.116251915907597   0.858014033544073   0.008658115554329
            0.858014033544073   0.025734050548330   0.008658115554329
            0.116251915907597   0.025734050548330   0.008658115554329
            0.858014033544073   0.116251915907597   0.008658115554329
            0.025734050548330   0.858014033544073   0.008658115554329
        ];
        X = all(:,1); Y = all(:,2); W = all(:,3);
        
    case 13
        all = [
            0.333333333333333   0.333333333333333   0.026260461700401
            0.009903630120591   0.495048184939705   0.005640072604665
            0.495048184939705   0.495048184939705   0.005640072604665
            0.495048184939705   0.009903630120591   0.005640072604665
            0.062566729780852   0.468716635109574   0.015711759181227
            0.468716635109574   0.468716635109574   0.015711759181227
            0.468716635109574   0.062566729780852   0.015711759181227
            0.170957326397447   0.414521336801277   0.023536251252097
            0.414521336801277   0.414521336801277   0.023536251252097
            0.414521336801277   0.170957326397447   0.023536251252097
            0.541200855914337   0.229399572042831   0.023681793268178
            0.229399572042831   0.229399572042831   0.023681793268178
            0.229399572042831   0.541200855914337   0.023681793268178
            0.771151009607340   0.114424495196330   0.015583764522897
            0.114424495196330   0.114424495196330   0.015583764522897
            0.114424495196330   0.771151009607340   0.015583764522897
            0.950377217273082   0.024811391363459   0.003987885732537
            0.024811391363459   0.024811391363459   0.003987885732537
            0.024811391363459   0.950377217273082   0.003987885732537
            0.094853828379579   0.268794997058761   0.018424201364366
            0.268794997058761   0.636351174561660   0.018424201364366
            0.636351174561660   0.094853828379579   0.018424201364366
            0.268794997058761   0.094853828379579   0.018424201364366
            0.636351174561660   0.268794997058761   0.018424201364366
            0.094853828379579   0.636351174561660   0.018424201364366
            0.018100773278807   0.291730066734288   0.008700731651911
            0.291730066734288   0.690169159986905   0.008700731651911
            0.690169159986905   0.018100773278807   0.008700731651911
            0.291730066734288   0.018100773278807   0.008700731651911
            0.690169159986905   0.291730066734288   0.008700731651911
            0.018100773278807   0.690169159986905   0.008700731651911
            0.022233076674090   0.126357385491669   0.007760893419522
            0.126357385491669   0.851409537834241   0.007760893419522
            0.851409537834241   0.022233076674090   0.007760893419522
            0.126357385491669   0.022233076674090   0.007760893419522
            0.851409537834241   0.126357385491669   0.007760893419522
            0.022233076674090   0.851409537834241   0.007760893419522
        ];
        X = all(:,1); Y = all(:,2); W = all(:,3);
        
    otherwise
        [X,Y,W]=simplexquad_old(m,dim);
%         Jloc = [-1 -1; 1 0];
%         x = [1;0];
%         
%         V = (Jloc)*[X,Y]' + x(:,ones(length(X),1));
%         X = V(1,:)';
%         Y = V(2,:)';
end
end


function [X,Y,W]=simplexquad_old(varargin)

% simplexquad.m - Gaussian Quadrature for an n-dimensional simplex.
%
% Construct Gauss points and weights for a n-dimensional simplex 
% domain with vertices specified by the n*(n-1) matrix vert. Where each 
% row contains the coordinates (x1,...,xn) for a vertex. The order of
% the quadrature scheme in each dimension must be the same in this
% implementation.
%
% Sample Usage:
%
% [X,W]=simplexquad(n,vert); % Specify the vertices 
% [X,W]=simplexquad(n,dim);  % Specify the dimension and use unit simplex 
%
% X will be a matrix for which the jth column are the grid points in each
% coordinate xj. 
%
% Note: The standard n-dimensional simplex has vertices specified
%       vert=eye(n+1,n).
%
% The first four simplexes are
%
% n | Domain
% --|------------
% 1 | Interval 
% 2 | Triangle
% 3 | Tetrahedron
% 4 | Pentatope 
%
% Written by: Greg von Winckel  
% Contact: gregvw(at)math(dot)unm(dot)edu
% http://math.unm.edu/~gregvw

nargin=length(varargin);

if nargin~=2
    error('simplexquad takes two input arguments');
end

N=varargin{1}; 

if length(N)~=1
    error('First argument must be a scalar');
end

if N~=abs(round(N-1))+1;
    error('Number of Gauss points must be a natural number');
end
    
if length(varargin{2})==1  % Dimension specified
    n=varargin{2}; 
    
    if n~=abs(round(n-1))+1;
        error('Dimension must be a natural number');
    end    
    
    m=n+1; vert=eye(m,n);   
else                      % Vertices specified
    vert=varargin{2}; 
    [m,n]=size(vert);
    
    if m~=n+1 
        error('The matrix of vertices must have n+1 rows and n columns');
    end
end
    
Nn=N^n;

if n==1 % The 1-D simplex is only an interval
    [q,w]=rquad(N,0); len=diff(vert);
    X=vert(1)+len*q;  W=abs(len)*w;

else % Find quadrature rules for higher dimensional domains     

    for k=1:n 
        [q{k},w{k}]=rquad(N,n-k);
    end

    [Q{1:n}]=ndgrid(q{:}); q=reshape(cat(n,Q{:}),Nn,n);
    [W{1:n}]=ndgrid(w{:}); w=reshape(cat(n,W{:}),Nn,n);

    map=eye(m); map(2:m,1)=-1; c=map*vert;
    W=abs(det(c(2:m,:)))*prod(w,2);

    qp=cumprod(q,2); e=ones(Nn,1);
    X=[e [(1-q(:,1:n-1)),e].*[e,qp(:,1:n-2),qp(:,n)]]*c;
    
    Y = X(:,2);
    X = X(:,1);
end

end


function [x,w]=rquad(N,k)

k1=k+1; k2=k+2; n=1:N;  nnk=2*n+k;
A=[k/k2 repmat(k^2,1,N)./(nnk.*(nnk+2))];
n=2:N; nnk=nnk(n);
B1=4*k1/(k2*k2*(k+3)); nk=n+k; nnk2=nnk.*nnk;
B=4*(n.*nk).^2./(nnk2.*nnk2-nnk2);
ab=[A' [(2^k1)/k1; B1; B']]; s=sqrt(ab(2:N,2));
[V,X]=eig(diag(ab(1:N,1),0)+diag(s,-1)+diag(s,1));
[X,I]=sort(diag(X));    
x=(X+1)/2; w=(1/2)^(k1)*ab(1,2)*V(1,I)'.^2;
end
   